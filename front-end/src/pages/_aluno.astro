---
import Layout from "@layout/Layout.astro";
import Header from "@components/astro/header.astro";
import Navbar from "@components/astro/NavbarStudent.astro"
import "@styles/css/navbar.css";
import "@styles/css/section.css";
import "@styles/css/student.css";
---

<Layout title="aluno">

 <Header icon="fa-pencil-alt" title="Área do Aluno" />
 
<div class="modal fade" id="USER_EDIT_MODAL" tabindex="-1" aria-labelledby="USER_EDIT_MODALLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="editProfileForm">
      <div class="modal-header">
        <h5 class="modal-title" id="USER_EDIT_MODALLabel">
          <i class="fas fa-user-edit me-2"></i> Editar Perfil
        </h5>
      </div>
      <div class="modal-body">

        <div class="mb-3">
          <label for="USER_INPUT_NAME" class="form-label">
            <i class="fas fa-user me-1"></i> Nome
          </label>
          <input type="text" class="form-control" id="USER_INPUT_NAME" name="name"
          placeholder="Shaun Carneiro" required>
        </div>

        <div class="mb-3">
          <label for="USER_INPUT_EMAIL" class="form-label">
            <i class="fas fa-envelope me-1"></i> Email (não editável)
          </label>
          <input type="email" class="form-control" id="USER_INPUT_EMAIL" name="email"
          placeholder="exemplo@mail.com" readonly>
        </div>

        <div class="mb-3">
          <label for="USER_INPUT_PHONE" class="form-label">
            <i class="fab fa-whatsapp me-1"></i> WhatsApp 
          </label>
          <input type="tel" class="form-control" id="USER_INPUT_PHONE"
          placeholder="+XX (XX) X XXXX-XXXX" name="phone" maxlength="20">
        </div>

      </div>
      <div class="modal-footer d-flex justify-content-end gap-2">
  <button class="btn btn-secondary btn-sm d-flex align-items-center gap-1" data-bs-dismiss="modal">
    <i class="fas fa-times"></i> Fechar
  </button>
  <button id="USER_EDIT_SAVE" class="btn btn-primary btn-sm d-flex align-items-center gap-1">
    <i class="fas fa-save"></i> Salvar
  </button>
</div>
    </div>
  </div>
</div>

<Navbar />

<p class="welcome" tabindex="0">Olá, <strong id="user_name">"?"</strong>.
Bem-vindo(a) ao seu painel de estudos.</p>

<section id="perfil" class="profile-section card" aria-label="Informações básicas do aluno">
  <h3 class="card-title">
    <i class="fas fa-user-circle"></i> Meu Perfil
  </h3>

  <div class="profile-img-wrapper">
    <img id="user_picture" src="https://cdn.discordapp.com/attachments/1346893120528449577/1404609886989320212/sem-foto.png?ex=689bd065&is=689a7ee5&hm=6b0f0721ea3d381dbc10e7e7dacc0c8dc3dca2247fe09033bd1bef3ab191c99b&"/>
  </div>

<ul class="profile-info">
  <li><i class="fas fa-user"></i> ------------------------ </li>
  <li><i class="fas fa-envelope"></i> ------------------------ </li>
  <li><i class="fas fa-phone"></i> ------------------------ </li>
  <li><i class="fas fa-layer-group"></i> ------------------------ </li>
</ul>

<div class="profile-actions">
  <button type="button" class="button" data-bs-toggle="modal" data-bs-target="#USER_EDIT_MODAL">
    <i class="fas fa-edit"></i>
  </button>
</div>

</section>

 <section class="plan-expired card p-3 mb-4 mx-auto" aria-label="Aviso de plano
 inativo" hidden>
  <h3 class="mb-3 text-danger" style="font-weight: 700; font-family: 'Fredoka One', cursive;">
    <i class="fas fa-exclamation-triangle me-2"></i> Nenhum Plano Ativo
  </h3>
  <p class="text-center fw-semibold" style="color: #d9534f; font-family: 'Fredoka One', cursive; font-size: 1rem; margin-bottom: 1.5rem;">
    Você não possui nenhum plano ativo no momento.<br>
    Para continuar aproveitando as aulas e conteúdos, por favor, escolha um plano e faça a assinatura.
  </p>
    <a href="/#assine-agora" class="btn btn-danger btn-renovar d-inline-flex align-items-center gap-2 px-4 py-2 fw-semibold" style="border-radius: 50px; font-family: 'Fredoka One', cursive; font-size: 1rem; min-width: 160px;">
    <i class="fas fa-shopping-cart me-2"></i> Assinar Plano
  </a>
</section>

  <section id="contato" class="contact-section" aria-label="Suporte e contato">
    <h3><i class="fas fa-headset"></i> Precisa de ajuda?</h3>
    <p>Entre em contato com nosso suporte para tirar dúvidas ou solicitar auxílio.</p>
    <a href="https://wa.me/5586981390994" target="_blank" rel="noopener noreferrer" class="button-contact" role="button" aria-label="Enviar mensagem pelo WhatsApp">
  <i class="fab fa-whatsapp"></i> WhatsApp
</a>
  </section>
  
<script>
import { User } from "@script/ts/axios.ts";
import Cookies from "js-cookie";
import $ from "jquery";

const decode = (encoded) => {
  try {
    return JSON.parse(decodeURIComponent(escape(atob(encoded))));
  } catch {
    return false;
  }
};

const Phone = (raw) => {
  if (!raw) return '';
  let numbers = raw.replace(/\D/g, '');
  if (numbers.length > 11) numbers = numbers.slice(0, 11);
  let formatted = "+55 ";
  if (numbers.length > 0) formatted += '(' + numbers.slice(0, 2) + ') ';
  if (numbers.length >= 3) formatted += numbers.slice(2, 3) + ' ';
  if (numbers.length >= 7) {
    formatted += numbers.slice(3, 7) + '-' + numbers.slice(7);
  } else if (numbers.length > 3) {
    formatted += numbers.slice(3);
  }
  return formatted;
};

if (!Cookies.get('USER_DATE')) {
  location.href = '/';
};

$('#logout').on('click', () => {
  Cookies.remove('USER_DATE');
  Cookies.remove('accessToken');
  location.href = '/';
});
  
const USER = await User(decode(Cookies.get('USER_DATE')).uid);

$('#user_name').text(USER.name);
$('#user_picture').attr('src', USER.picture);
$('.profile-info li').eq(0).html(`<i class="fas fa-user"></i> ${USER.name}`);
$('.profile-info li').eq(1).html(`<i class="fas fa-envelope"></i>
${USER.email}`);
$('.profile-info li').eq(2).html(`<i class="fas fa-phone"></i> ${Phone(USER.phone) || 'Não informado'}`);
$('.profile-info li').eq(3).html(`
  <i class="fas fa-layer-group" ${USER?.userPlans?.[0]?.plan ? "" : 'style="color:red;"'}></i>
  <span ${USER?.userPlans?.[0]?.plan ? "" : 'style="color:red;"'}>
    ${USER?.userPlans?.[0]?.plan?.name ?? "Nenhum plano ativo"}
  </span>
`);

if (!USER?.userPlans?.[0]?.plan?.name) {
  $(".plan-expired").attr("hidden", false); 
};

</script>
</layout>